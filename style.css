document.addEventListener('DOMContentLoaded', () => {
    // --- URLs and Elements ---
    const BASE_URL = 'https://translation-929510129831.europe-west1.run.app';
    const FILE_TRANSLATE_URL = `${BASE_URL}/translate-file`;
    const TEXT_TRANSLATE_URL = `${BASE_URL}/translate-text`;

    const fileForm = document.getElementById('file-upload-form');
    const fileInput = document.getElementById('file-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const uploadArea = document.getElementById('upload-area');
    const fileStatusContainer = document.getElementById('file-status-container');
    const translateFileBtn = document.getElementById('translate-file-btn');
    
    const sourceTextArea = document.getElementById('source-text');
    const targetTextArea = document.getElementById('target-text');
    const copyBtn = document.getElementById('copy-btn');

    const languages = {
        'Arabic': 'ar', 'English': 'en', 'Spanish': 'es', 'French': 'fr', 'German': 'de',
        'Italian': 'it', 'Japanese': 'ja', 'Korean': 'ko', 'Chinese': 'zh',
        'Russian': 'ru', 'Portuguese': 'pt', 'Hindi': 'hi', 'Turkish': 'tr'
    };
    
    // --- Functions ---
    function populateLanguageSelectors() {
        const selectors = document.querySelectorAll('select');
        selectors.forEach(selector => {
            if (selector.id.includes('source')) {
                 selector.innerHTML = '<option value="auto">Auto-Detect / كشف تلقائي</option>';
            } else {
                 selector.innerHTML = '';
            }
            for (const name of Object.keys(languages)) {
                selector.add(new Option(name, name));
            }
        });
        document.getElementById('file-target-lang').value = 'Arabic';
        document.getElementById('text-target-lang').value = 'Arabic';
    }

    function showFileStatus(message, isError = false) {
        fileStatusContainer.style.display = 'block';
        fileStatusContainer.textContent = message;
        fileStatusContainer.style.color = isError ? '#d93025' : 'var(--text-secondary)';
        fileStatusContainer.style.backgroundColor = isError ? '#fce8e6' : '#eef2f5';
    }

    function hideFileStatus() {
        fileStatusContainer.style.display = 'none';
    }

    async function handleFileSubmit(e) {
        e.preventDefault();
        if (fileInput.files.length === 0) {
            showFileStatus('Please select a file first. / الرجاء اختيار ملف أولاً.', true);
            return;
        }

        const formData = new FormData(fileForm);
        showFileStatus('Processing... This may take a moment for large files. / جاري المعالجة...');
        translateFileBtn.disabled = true;

        try {
            const response = await fetch(FILE_TRANSLATE_URL, { method: 'POST', body: formData });

            if (!response.ok) {
                // نحاول قراءة الخطأ من الـ JSON الذي أرسلناه من الخلفية
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            // التعامل مع تحميل الملف
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'translated_document.docx';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch.length > 1) {
                    filename = filenameMatch[1];
                }
            }
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(downloadUrl);
            
            showFileStatus('Translation complete and download started! / اكتملت الترجمة وبدأ التحميل!');

        } catch (error) {
            console.error('File Translation Error:', error);
            showFileStatus(error.message, true);
        } finally {
            translateFileBtn.disabled = false;
        }
    }

    async function handleTextTranslation() {
        const text = sourceTextArea.value.trim();
        if (!text) return;
        targetTextArea.placeholder = "Translating... / جاري الترجمة...";
        try {
            const response = await fetch(TEXT_TRANSLATE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    target_lang: document.getElementById('text-target-lang').value
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            targetTextArea.value = data.translated_text;
        } catch (error) {
            targetTextArea.value = `Error: ${error.message}`;
        }
    }

    // --- Event Listeners ---
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileNameDisplay.querySelector('.en b').textContent = fileInput.files[0].name;
            fileNameDisplay.querySelector('.ar b').textContent = '';
            hideFileStatus();
        }
    });
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });
    uploadArea.addEventListener('drop', e => {
        fileInput.files = e.dataTransfer.files;
        fileInput.dispatchEvent(new Event('change'));
    }, false);

    fileForm.addEventListener('submit', handleFileSubmit);
    
    let debounceTimer;
    sourceTextArea.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(handleTextTranslation, 800);
    });

    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(targetTextArea.value).then(() => {
            copyBtn.title = 'Copied!';
            setTimeout(() => { copyBtn.title = 'Copy text'; }, 2000);
        });
    });

    // --- Initialization ---
    populateLanguageSelectors();
});

function openTab(evt, tabName) {
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    evt.currentTarget.classList.add('active');
}
